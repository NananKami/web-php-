# 约束攻击 (SQL 数据库截断漏洞) 知识体系拆解

约束攻击（Constraint Attack），通常被称为 **SQL 截断攻击**，是一种利用数据库插入数据时的“自动截断”特性与字符串比较特性，从而绕过系统业务逻辑（如越权、账号劫持）的漏洞。



---

## 1. 核心原理与前置条件

这个漏洞的产生，依赖于数据库（特别是旧版本或未开启严格模式的 MySQL）的两个特性：

### 特性 A：超长数据自动截断
当数据库表的某个字段限制了最大长度（例如 `username VARCHAR(20)`），如果程序向该字段插入长度超过 20 的字符串，在**非严格模式**下，数据库不会报错停止执行，而是会**默默地将超出的部分截断**，只保留前 20 个字符存入数据库。

### 特性 B：字符串比较忽略尾部空格
在 MySQL 中，默认的字符集排序规则（Collation，通常带有 `PADSPACE` 属性）在进行字符串比较（使用 `=` 操作符）时，会**自动忽略字符串尾部的空格**。
- 例如：在数据库看来，`'admin'` 和 `'admin   '` 是相等的。

---

## 2. 经典攻击场景：接管 Admin 账号

假设目标网站有一个注册页面，数据库中 `username` 字段的最大长度限制为 **20 个字符**。系统当前已经存在一个超级管理员账号：`admin`。

攻击者的目标是：**重置 `admin` 的密码，或以 `admin` 身份登录。**

### 攻击步骤拆解：

#### Step 1: 构造恶意用户名发起注册
攻击者在注册页面输入一个精心构造的用户名，由“目标账号 + 大量空格 + 任意字符”组成，使其总长度远超 20：
> 用户名输入：`admin               x`  *(注意：admin 后面跟着 15 个空格，加上 x，总长度 21)*
> 密码输入：`123456`

#### Step 2: 绕过应用层的“查重”逻辑
后端代码在注册前，通常会先查询该用户是否已存在：
```sql
SELECT * FROM users WHERE username = 'admin               x';
